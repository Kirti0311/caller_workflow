name: Get PR Approver and Merger

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
    outputs:
      approver:
        description: "GitHub username of the person who approved the PR"
        value: ${{ jobs.get-pr-info.outputs.approver }}
      merger:
        description: "GitHub username of the person who merged the PR"
        value: ${{ jobs.get-pr-info.outputs.merger }}

jobs:
  get-pr-info:
    runs-on: ubuntu-latest
    outputs:
      approver: ${{ steps.pr-info.outputs.approver }}
      merger:  ${{ steps.pr-info.outputs.merger }}

    steps:
      - name: Get PR Approver and Merger
        id: pr-info
        run: |
            PR_NUMBER="${{ inputs.pr_number }}"
            REPO="${{ github.repository }}"

            echo "Using PR_NUMBER=$PR_NUMBER"
            echo "Using REPO=$REPO"

            echo "All reviews for debugging:"
            gh api repos/$REPO/pulls/$PR_NUMBER/reviews --jq '.[] | {user: .user.login, state: .state}' || echo "No reviews found"

            # Get approvals
            APPROVER=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews \
            --jq '.[] | select(.state=="APPROVED") | .user.login' | head -1)

            # Get merger info
            MERGER=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergedBy --jq '.mergedBy.login')

            echo "Resolved APPROVER=$APPROVER"
            echo "Resolved MERGER=$MERGER"

            echo "approver=$APPROVER" >> "$GITHUB_OUTPUT"
            echo "merger=$MERGER"     >> "$GITHUB_OUTPUT"
        env:
            GH_TOKEN: ${{ github.token }}